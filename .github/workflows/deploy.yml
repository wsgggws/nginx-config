name: Deploy Nginx Configuration

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.REMOTE_IP }} >> ~/.ssh/known_hosts

      - name: ğŸ“ Copy nginx configuration files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.REMOTE_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "config/nginx/**"
          target: "/tmp/nginx-deploy/"
          strip_components: 0
          overwrite: true

      - name: ğŸ“œ Copy restart script to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.REMOTE_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "scripts/restart.sh"
          target: "/tmp/nginx-deploy/"
          strip_components: 0
          overwrite: true

      - name: ğŸ“‹ Copy documentation files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.REMOTE_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "README.md,docs/**"
          target: "/tmp/nginx-deploy/"
          strip_components: 0
          overwrite: true

      - name: ğŸš€ Deploy nginx configuration
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.REMOTE_IP }} << 'EOF'
            set -e
            
            echo "ğŸ“¦ éƒ¨ç½² nginx é…ç½®æ–‡ä»¶..."
            
            # å¤‡ä»½å½“å‰ nginx é…ç½®
            BACKUP_DIR="/etc/nginx/backup/$(date +%Y%m%d_%H%M%S)"
            sudo mkdir -p "$BACKUP_DIR"
            sudo cp -r /etc/nginx/nginx.conf "$BACKUP_DIR/" 2>/dev/null || true
            sudo cp -r /etc/nginx/conf.d/* "$BACKUP_DIR/" 2>/dev/null || true
            sudo cp -r /etc/nginx/snippets/* "$BACKUP_DIR/" 2>/dev/null || true
            echo "âœ“ å·²å¤‡ä»½åˆ° $BACKUP_DIR"
            
            # å¤åˆ¶æ–°çš„é…ç½®æ–‡ä»¶
            echo "ğŸ“ å¤åˆ¶æ–°é…ç½®æ–‡ä»¶..."
            sudo cp -r /tmp/nginx-deploy/config/nginx/nginx.conf /etc/nginx/nginx.conf
            sudo cp -r /tmp/nginx-deploy/config/nginx/conf.d/* /etc/nginx/conf.d/
            sudo mkdir -p /etc/nginx/snippets
            sudo cp -r /tmp/nginx-deploy/config/nginx/snippets/* /etc/nginx/snippets/
            
            # æ‰§è¡Œé‡å¯è„šæœ¬
            echo "ğŸ”„ æ‰§è¡Œé‡å¯è„šæœ¬..."
            sudo chmod +x /tmp/nginx-deploy/scripts/restart.sh
            sudo /tmp/nginx-deploy/scripts/restart.sh
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
            rm -rf /tmp/nginx-deploy
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          EOF

      - name: ğŸ“Š Deployment summary
        if: success()
        run: |
          echo "ğŸ‰ Nginx é…ç½®å·²æˆåŠŸéƒ¨ç½²åˆ°æœåŠ¡å™¨"
          echo "æœåŠ¡å™¨: ${{ secrets.REMOTE_IP }}"
          echo "éƒ¨ç½²æ—¶é—´: $(date)"
