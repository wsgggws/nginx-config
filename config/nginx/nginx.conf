# ============================================
# Nginx 主配置文件
# 中央 Nginx 项目 - 基础设施配置
# ============================================

# 工作进程数（建议设置为 CPU 核心数，auto 自动检测）
worker_processes auto;

# 每个工作进程的最大文件描述符数
worker_rlimit_nofile 65535;

events {
  # 每个工作进程的最大连接数
  worker_connections 4096;
  
  # 使用高效的事件模型（Linux）
  use epoll;
  
  # 尽可能多地接受连接
  multi_accept on;
}

http {
  # ============================================
  # 基础配置
  # ============================================
  
  include       mime.types;
  default_type  application/octet-stream;
  
  # 字符集
  charset utf-8;
  
  # ============================================
  # 日志配置
  # ============================================
  
  # 日志格式
  log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                  '$status $body_bytes_sent "$http_referer" '
                  '"$http_user_agent" "$http_x_forwarded_for" '
                  'rt=$request_time uct="$upstream_connect_time" '
                  'uht="$upstream_header_time" urt="$upstream_response_time"';
  
  # 访问日志
  access_log /var/log/nginx/access.log main buffer=32k flush=5s;
  error_log  /var/log/nginx/error.log warn;
  
  # ============================================
  # 性能优化
  # ============================================
  
  # 高效文件传输
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  
  # 连接超时
  keepalive_timeout 65;
  keepalive_requests 100;
  
  # 客户端请求限制
  client_max_body_size 100M;
  client_body_buffer_size 128k;
  client_header_buffer_size 4k;
  large_client_header_buffers 4 8k;
  
  # 超时设置
  client_body_timeout 12s;
  client_header_timeout 12s;
  send_timeout 10s;
  
  # 隐藏 Nginx 版本号
  server_tokens off;
  
  # ============================================
  # 引入公共配置片段
  # ============================================
  
  # SSL 通用参数（已在 snippets 中定义，站点配置时引用）
  # include /etc/nginx/snippets/ssl-params.conf;
  
  # Gzip 压缩
  include /etc/nginx/snippets/gzip.conf;
  
  # ============================================
  # 速率限制区域定义
  # ============================================
  
  # 限制单个 IP 的请求速率（可根据需要调整）
  limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
  limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;
  
  # 限制连接数
  limit_conn_zone $binary_remote_addr zone=addr:10m;
  
  # ============================================
  # 缓存配置（如需要反向代理缓存）
  # ============================================
  
  # proxy_cache_path /var/cache/nginx/proxy 
  #                  levels=1:2 
  #                  keys_zone=proxy_cache:100m 
  #                  max_size=10g 
  #                  inactive=60m 
  #                  use_temp_path=off;
  
  # ============================================
  # 默认服务器（捕获未匹配的请求）
  # ============================================
  
  server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;
    
    # 拒绝所有未明确配置的域名请求
    return 444;
  }
  
  # ============================================
  # 引入站点配置
  # ============================================
  
  # 所有站点配置（包括 HTTP 重定向和 HTTPS 配置）
  include /etc/nginx/conf.d/*.conf;
}
